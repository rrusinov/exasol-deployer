#!/bin/bash
# This script creates stable /dev/exasol_data_* symlinks for EBS volumes
# It runs on boot via systemd to ensure symlinks persist across reboots
#
# Generated by Ansible - DO NOT EDIT MANUALLY
# Volume IDs: {{ volume_ids_list | join(', ') }}

set -euo pipefail

# Volume IDs passed from Terraform/Ansible (sorted for stable ordering)
VOLUME_IDS=(
{% for vol_id in volume_ids_list | sort %}
    "{{ vol_id }}"
{% endfor %}
)

# Target symlink prefix
SYMLINK_PREFIX="/dev/exasol_data_"

# Log function
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | systemd-cat -t exasol-data-symlinks -p info
}

log "Starting Exasol data volume symlink creation"

# Remove any existing symlinks
for link in ${SYMLINK_PREFIX}*; do
    if [ -L "$link" ]; then
        rm -f "$link"
        log "Removed stale symlink: $link"
    fi
done

# Create symlinks for each volume in sorted order
# ONLY for unmounted volumes (to prevent overwriting OS or other mounted filesystems)
disk_idx=1
for vol_id in "${VOLUME_IDS[@]}"; do
    vol_id_short="${vol_id//-/}"

    # Find the device using the by-id symlink
    found=false
    for link in /dev/disk/by-id/nvme-Amazon_Elastic_Block_Store_${vol_id_short}*; do
        [[ ! -e "$link" ]] && continue
        # Skip partition symlinks (ending with _1, _2, etc)
        [[ "$link" =~ _[0-9]+$ ]] && continue

        target=$(readlink -f "$link")
        # Verify it's a whole disk (not partition)
        if [[ "$target" =~ nvme[0-9]+n[0-9]+$ ]]; then
            # CRITICAL SAFETY CHECK: Verify volume is not mounted
            if lsblk -nlo MOUNTPOINT "$target" | grep -q '^/'; then
                log "SKIPPING: $target (volume: $vol_id) - has mounted partitions (likely root or other OS volume)"
                found=true
                break
            fi

            symlink_name=$(printf "${SYMLINK_PREFIX}%02d" "$disk_idx")
            ln -sf "$target" "$symlink_name"
            log "Created symlink: $symlink_name -> $target (volume: $vol_id)"
            found=true
            ((disk_idx++))
            break
        fi
    done

    if [ "$found" = false ]; then
        log "ERROR: Could not find EBS volume $vol_id"
        log "Available EBS volumes:"
        ls -l /dev/disk/by-id/nvme-Amazon_Elastic_Block_Store_* 2>/dev/null | while read line; do
            log "  $line"
        done || log "  (none found)"
        exit 1
    fi
done

symlink_count=$((disk_idx - 1))
log "Successfully created $symlink_count Exasol data volume symlinks (${#VOLUME_IDS[@]} volumes configured, skipped mounted volumes)"
exit 0

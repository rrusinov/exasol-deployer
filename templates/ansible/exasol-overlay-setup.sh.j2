#!/usr/bin/env bash
# Generated by Ansible - Configures a simple VXLAN overlay for multicast traffic
# Uses native Linux VXLAN with dynamic FDB learning - no static configuration needed

set -euo pipefail

readonly NODE_NAME="{{ inventory_hostname }}"
readonly OVERLAY_IP="{{ overlay_ip }}"
readonly PUBLIC_IP="{{ ansible_host }}"
readonly OVERLAY_NETWORK="172.16.0.0/16"
readonly CLUSTER_NAME="exasol-vxlan"
readonly VXLAN_ID="1000"
readonly VXLAN_PORT="4789"
readonly VXLAN_IFACE="vxlan0"
readonly BRIDGE_IFACE="vxlan-br0"
readonly BROADCAST_MAC="00:00:00:00:00:00"

# Seed nodes (physical IPs) used to bootstrap flooding/FDB learning
SEED_NODES=(
{% for seed in seed_nodes %}
"{{ seed.ip }}"
{% endfor %}
)

# Dynamic VXLAN - no static peer configuration needed!
# VXLAN will use FDB learning to discover peers automatically

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | systemd-cat -t exasol-overlay -p info
}

log "Configuring VXLAN overlay for ${NODE_NAME} (overlay IP: ${OVERLAY_IP})"

if [[ -z "${OVERLAY_IP}" ]]; then
    log "Overlay IP is not defined; aborting VXLAN setup"
    exit 1
fi

# Enable IP forwarding and multicast support
sysctl -w net.ipv4.ip_forward=1 >/dev/null
sysctl -w net.ipv4.conf.all.forwarding=1 >/dev/null
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
echo "net.ipv4.conf.all.forwarding=1" >> /etc/sysctl.conf

# Load VXLAN kernel module
modprobe vxlan
echo "vxlan" >> /etc/modules

# Determine primary interface to bind tunnels (prefer default route, skip loopback)
primary_iface=$(ip route show default 2>/dev/null | awk '/default/ {for (i=1;i<=NF;i++) if ($i=="dev") {print $(i+1); exit}}')
if [[ -z "${primary_iface}" || "${primary_iface}" == "lo" ]]; then
    primary_iface=$(ip route get "${PUBLIC_IP}" 2>/dev/null | awk '{for (i=1;i<=NF;i++) if ($i=="dev") {print $(i+1); exit}}')
fi
if [[ -z "${primary_iface}" || "${primary_iface}" == "lo" ]]; then
    log "Unable to determine primary network interface"
    exit 1
fi

# Clean up any existing overlay devices
if ip link show "${BRIDGE_IFACE}" >/dev/null 2>&1; then
    log "Removing existing bridge ${BRIDGE_IFACE}"
    ip link set dev "${BRIDGE_IFACE}" down || true
    ip link delete "${BRIDGE_IFACE}" type bridge || true
fi

# Remove any existing VXLAN interface
if ip link show "${VXLAN_IFACE}" >/dev/null 2>&1; then
    log "Removing existing VXLAN interface ${VXLAN_IFACE}"
    ip link set dev "${VXLAN_IFACE}" down
    ip link delete "${VXLAN_IFACE}"
fi

# Create VXLAN interface with dynamic FDB learning
log "Creating VXLAN interface ${VXLAN_IFACE} on ${primary_iface}"
ip link add "${VXLAN_IFACE}" type vxlan \
    id "${VXLAN_ID}" \
    dstport "${VXLAN_PORT}" \
    dev "${primary_iface}" \
    learning \
    l2miss \
    l3miss

# Configure VXLAN interface
ip link set dev "${VXLAN_IFACE}" up

# Create bridge to host the overlay IP (gives operstate UP)
log "Creating bridge ${BRIDGE_IFACE} and assigning overlay IP"
ip link add name "${BRIDGE_IFACE}" type bridge
ip link set "${BRIDGE_IFACE}" up
ip addr replace "${OVERLAY_IP}/16" dev "${BRIDGE_IFACE}"
ip link set "${VXLAN_IFACE}" master "${BRIDGE_IFACE}"

# Add route for overlay network
ip route replace "${OVERLAY_NETWORK}" dev "${BRIDGE_IFACE}" || true

# Seed initial FDB/ARP entries to peers so traffic floods out
for seed_ip in "${SEED_NODES[@]}"; do
    [[ -z "${seed_ip}" || "${seed_ip}" == "${PUBLIC_IP}" ]] && continue
    bridge fdb append "${BROADCAST_MAC}" dev "${VXLAN_IFACE}" dst "${seed_ip}" 2>/dev/null || true
done

# Verify overlay setup
log "Verifying VXLAN overlay network..."
if ip link show "${VXLAN_IFACE}" >/dev/null 2>&1 && ip link show "${BRIDGE_IFACE}" >/dev/null 2>&1; then
    log "VXLAN overlay interface ${VXLAN_IFACE} created successfully"
    log "Overlay bridge ${BRIDGE_IFACE} is present"
    log "Overlay IP: ${OVERLAY_IP}/16"
    log "VXLAN ID: ${VXLAN_ID}"
    log "Primary interface: ${primary_iface}"
    
    # Test multicast capability
    log "Testing multicast support on overlay interface..."
    if ip addr show "${BRIDGE_IFACE}" | grep -q "${OVERLAY_IP}"; then
        log "✓ VXLAN overlay is ready for multicast traffic"
        log "✓ Nodes can join/leave dynamically via FDB learning"
    else
        log "✗ VXLAN overlay configuration issue"
        exit 1
    fi
else
    log "✗ VXLAN overlay interface creation failed"
    exit 1
fi

log "Dynamic VXLAN overlay setup completed for node ${NODE_NAME}"
log "New nodes will be discovered automatically via FDB learning"

exit 0

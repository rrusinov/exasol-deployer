#!/usr/bin/env bash
# Generated by Ansible - Configures a simple VXLAN overlay for multicast traffic
# Uses native Linux VXLAN with dynamic FDB learning - no static configuration needed

set -euo pipefail

readonly NODE_NAME="{{ inventory_hostname }}"
readonly OVERLAY_IP="{{ overlay_ip }}"
readonly PUBLIC_IP="{{ ansible_host }}"
readonly OVERLAY_NETWORK="172.16.0.0/16"
readonly CLUSTER_NAME="exasol-vxlan"
readonly VXLAN_ID="1000"
readonly VXLAN_PORT="4789"
readonly VXLAN_IFACE="vxlan0"
readonly BRIDGE_IFACE="vxlan-br0"
readonly BROADCAST_MAC="00:00:00:00:00:00"

# Seed nodes (physical IPs) used to bootstrap flooding/FDB learning
SEED_NODES=(
{% for seed in seed_nodes %}
"{{ seed.ip }}"
{% endfor %}
)

# Dynamic VXLAN - no static peer configuration needed!
# VXLAN will use FDB learning to discover peers automatically

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | systemd-cat -t exasol-overlay -p info
}

log "Configuring VXLAN overlay for ${NODE_NAME} (overlay IP: ${OVERLAY_IP})"

if [[ -z "${OVERLAY_IP}" ]]; then
    log "Overlay IP is not defined; aborting VXLAN setup"
    exit 1
fi

trap 'log "ERROR: VXLAN overlay setup failed (line ${BASH_LINENO[0]}, exit code $?)"' ERR

# Enable IP forwarding and multicast support
sysctl -w net.ipv4.ip_forward=1 >/dev/null
sysctl -w net.ipv4.conf.all.forwarding=1 >/dev/null
if ! grep -q '^net.ipv4.ip_forward=1$' /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
fi
if ! grep -q '^net.ipv4.conf.all.forwarding=1$' /etc/sysctl.conf; then
    echo "net.ipv4.conf.all.forwarding=1" >> /etc/sysctl.conf
fi

# Load VXLAN kernel module
modprobe vxlan
if ! grep -qx "vxlan" /etc/modules; then
    echo "vxlan" >> /etc/modules
fi

wait_for_primary_iface() {
    local attempt=0
    local iface=""
    while [[ ${attempt} -lt 12 ]]; do
        iface=$(ip route show default 2>/dev/null | awk '/default/ {for (i=1;i<=NF;i++) if ($i=="dev") {print $(i+1); exit}}')
        if [[ -z "${iface}" || "${iface}" == "lo" ]]; then
            iface=$(ip route get "${PUBLIC_IP}" 2>/dev/null | awk '{for (i=1;i<=NF;i++) if ($i=="dev") {print $(i+1); exit}}')
        fi
        if [[ -n "${iface}" && "${iface}" != "lo" ]]; then
            echo "${iface}"
            return 0
        fi
        log "Waiting for primary network interface (attempt $((attempt + 1))/12)..."
        sleep 5
        attempt=$((attempt + 1))
    done

    log "ERROR: Unable to determine primary network interface after retries (last seen: ${iface:-none})"
    log "Available routes:"
    ip route show | systemd-cat -t exasol-overlay -p err
    log "Available interfaces:"
    ip -o link show | awk -F': ' '{print "  " $2}' | systemd-cat -t exasol-overlay -p err
    exit 1
}

primary_iface="$(wait_for_primary_iface)"
log "Using primary interface: ${primary_iface}"

# Clean up any existing overlay devices
if ip link show "${BRIDGE_IFACE}" >/dev/null 2>&1; then
    log "Removing existing bridge ${BRIDGE_IFACE}"
    ip link set dev "${BRIDGE_IFACE}" down || true
    ip link delete "${BRIDGE_IFACE}" type bridge || true
fi

# Remove any existing VXLAN interface
if ip link show "${VXLAN_IFACE}" >/dev/null 2>&1; then
    log "Removing existing VXLAN interface ${VXLAN_IFACE}"
    ip link set dev "${VXLAN_IFACE}" down
    ip link delete "${VXLAN_IFACE}"
fi

# Create VXLAN interface with dynamic FDB learning
log "Creating VXLAN interface ${VXLAN_IFACE} on ${primary_iface}"
ip link add "${VXLAN_IFACE}" type vxlan \
    id "${VXLAN_ID}" \
    dstport "${VXLAN_PORT}" \
    dev "${primary_iface}" \
    learning \
    l2miss \
    l3miss

# Configure VXLAN interface
ip link set dev "${VXLAN_IFACE}" up

# Create bridge to host the overlay IP (gives operstate UP)
log "Creating bridge ${BRIDGE_IFACE} and assigning overlay IP"
ip link add name "${BRIDGE_IFACE}" type bridge
ip link set "${BRIDGE_IFACE}" up
ip addr replace "${OVERLAY_IP}/16" dev "${BRIDGE_IFACE}"
ip link set "${VXLAN_IFACE}" master "${BRIDGE_IFACE}"

# Add route for overlay network
ip route replace "${OVERLAY_NETWORK}" dev "${BRIDGE_IFACE}" || true

# Seed initial FDB/ARP entries to peers so traffic floods out
for seed_ip in "${SEED_NODES[@]}"; do
    [[ -z "${seed_ip}" || "${seed_ip}" == "${PUBLIC_IP}" ]] && continue
    bridge fdb append "${BROADCAST_MAC}" dev "${VXLAN_IFACE}" dst "${seed_ip}" 2>/dev/null || true
done

# Verify overlay setup
log "Verifying VXLAN overlay network..."
if ip link show "${VXLAN_IFACE}" >/dev/null 2>&1 && ip link show "${BRIDGE_IFACE}" >/dev/null 2>&1; then
    log "VXLAN overlay interface ${VXLAN_IFACE} created successfully"
    log "Overlay bridge ${BRIDGE_IFACE} is present"
    log "Overlay IP: ${OVERLAY_IP}/16"
    log "VXLAN ID: ${VXLAN_ID}"
    log "Primary interface: ${primary_iface}"
    
    # Test multicast capability
    log "Testing multicast support on overlay interface..."
    if ip addr show "${BRIDGE_IFACE}" | grep -q "${OVERLAY_IP}"; then
        log "✓ VXLAN overlay is ready for multicast traffic"
        log "✓ Nodes can join/leave dynamically via FDB learning"
    else
        log "✗ VXLAN overlay configuration issue"
        exit 1
    fi
else
    log "✗ VXLAN overlay interface creation failed"
    exit 1
fi

log "Dynamic VXLAN overlay setup completed for node ${NODE_NAME}"
log "New nodes will be discovered automatically via FDB learning"

exit 0

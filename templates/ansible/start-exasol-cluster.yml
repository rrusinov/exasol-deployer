---
# ==============================================================================
# START EXASOL CLUSTER
# Starts a previously stopped Exasol database cluster.
# This playbook starts database services and waits for the cluster to be ready.
# ==============================================================================

# ==============================================================================
# PLAY 1: GATHER FACTS FROM ALL HOSTS
# ==============================================================================
- name: Play 1 - Gather Host Facts
  hosts: exasol_nodes
  become: yes
  tasks:
    - name: Wait for SSH to become available (VM may still be booting)
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 15
        sleep: 5

    - name: Ensure all host facts are gathered
      ansible.builtin.setup:

    - name: "PROGRESS: Ansible connection established"
      ansible.builtin.debug:
        msg: "PROGRESS_MARKER: start:03:Ansible_Connection"
      run_once: true

# ==============================================================================
# PLAY 2: START EXASOL DATABASE ON ALL NODES
# ==============================================================================
- name: Play 2 - Start Exasol Database
  hosts: exasol_nodes
  become: yes
  gather_facts: no

  vars:
    exa_user: "exasol"

  tasks:
    # ==============================================================================
    # START OPERATION
    # ==============================================================================
    - name: Display start operation information
      ansible.builtin.debug:
        msg: "Starting Exasol database cluster on {{ inventory_hostname }}..."
      run_once: true

    # ==============================================================================
    # VERIFY PREREQUISITES
    # ==============================================================================
    - name: Check current status of c4.service
      ansible.builtin.systemd:
        name: c4.service
      register: c4_service_status
      failed_when: false

    - name: Display current service status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: c4.service is {{ c4_service_status.status.ActiveState }}"
      when: c4_service_status.status is defined

    - name: Warn if service is already active
      ansible.builtin.debug:
        msg: "WARNING: {{ inventory_hostname }}: c4.service is already active. Proceeding with start anyway..."
      when:
        - c4_service_status.status is defined
        - c4_service_status.status.ActiveState == "active"

    # ==============================================================================
    # START DATABASE SERVICES VIA SYSTEMD ON ALL NODES
    # ==============================================================================
    - name: Wait for network to be ready (check default route)
      ansible.builtin.command: ip route show default
      register: default_route
      retries: 30
      delay: 2
      until: default_route.rc == 0 and default_route.stdout | length > 0
      changed_when: false
      failed_when: false

    # Restart overlay service only when overlay is configured
    - name: Restart overlay network service (VXLAN)
      when: overlay_ip is defined and overlay_ip | length > 0
      ansible.builtin.systemd:
        name: exasol-overlay.service
        state: restarted
      register: start_overlay
      failed_when: false

    - name: Wait for overlay service to be active
      when:
        - start_overlay is defined
        - not (start_overlay.skipped | default(false))
      ansible.builtin.systemd:
        name: exasol-overlay.service
      register: overlay_service_status
      until: overlay_service_status.status.ActiveState == "active"
      retries: 6
      delay: 5
      changed_when: false
      failed_when: false

    - name: Display overlay service status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: exasol-overlay.service is {{ overlay_service_status.status.ActiveState }} ({{ overlay_service_status.status.SubState }})"
      when:
        - start_overlay is defined
        - not (start_overlay.skipped | default(false))
        - overlay_service_status.status is defined

    - name: Get overlay service logs if not active
      ansible.builtin.command: journalctl -u exasol-overlay.service -n 100 --no-pager
      register: overlay_logs
      when:
        - start_overlay is defined
        - not (start_overlay.skipped | default(false))
        - overlay_service_status.status is defined
        - overlay_service_status.status.ActiveState != "active"
      changed_when: false
      failed_when: false

    - name: Display overlay service logs on failure
      ansible.builtin.debug:
        msg: "{{ overlay_logs.stdout_lines }}"
      when:
        - start_overlay is defined
        - not (start_overlay.skipped | default(false))
        - overlay_logs is defined
        - overlay_logs.stdout_lines is defined

    - name: Wait for overlay interface to be ready
      ansible.builtin.command: ip -o addr show vxlan-br0
      register: overlay_status
      retries: 30
      delay: 10
      until: overlay_status.rc == 0
      changed_when: false
      failed_when: overlay_status.rc != 0
      when:
        - start_overlay is defined
        - not (start_overlay.skipped | default(false))

    - name: Start exasol-data-symlinks.service (if exists)
      ansible.builtin.systemd:
        name: exasol-data-symlinks.service
        state: started
      register: start_data_symlinks
      failed_when: false

    - name: Check data-symlinks service status
      ansible.builtin.systemd:
        name: exasol-data-symlinks.service
      register: data_symlinks_status
      failed_when: false

    - name: Display data-symlinks service status if not active
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: exasol-data-symlinks.service is {{ data_symlinks_status.status.ActiveState | default('not found') }}"
      when:
        - data_symlinks_status.status is defined
        - data_symlinks_status.status.ActiveState != "active"

    - name: Start c4_cloud_command.service
      ansible.builtin.systemd:
        name: c4_cloud_command.service
        state: started
      register: start_cloud_command
      failed_when: false

    - name: Check c4_cloud_command service status
      ansible.builtin.systemd:
        name: c4_cloud_command.service
      register: cloud_command_status

    - name: Get c4_cloud_command logs if not active
      ansible.builtin.command: journalctl -u c4_cloud_command.service -n 30 --no-pager
      register: cloud_command_logs
      when:
        - cloud_command_status.status is defined
        - cloud_command_status.status.ActiveState != "active"
      changed_when: false
      failed_when: false

    - name: Display c4_cloud_command logs on failure
      ansible.builtin.debug:
        msg: "{{ cloud_command_logs.stdout_lines }}"
      when:
        - cloud_command_logs is defined
        - cloud_command_logs.stdout_lines is defined

    - name: Start c4.service (main Exasol database service)
      ansible.builtin.systemd:
        name: c4.service
        state: started
      register: start_c4
      when:
        - c4_service_status.status is not defined
          or c4_service_status.status.ActiveState != "active"

    - name: Check c4.service status
      ansible.builtin.systemd:
        name: c4.service
      register: c4_status

    - name: Get c4.service logs if not active
      ansible.builtin.command: journalctl -u c4.service -n 30 --no-pager
      register: c4_logs
      when:
        - c4_status.status is defined
        - c4_status.status.ActiveState != "active"
      changed_when: false
      failed_when: false

    - name: Display c4.service logs on failure
      ansible.builtin.debug:
        msg: "{{ c4_logs.stdout_lines }}"
      when:
        - c4_logs is defined
        - c4_logs.stdout_lines is defined

    - name: Wait for c4.service to be fully active
      ansible.builtin.wait_for:
        timeout: 60
      when:
        - start_c4 is defined
        - start_c4.changed
      failed_when: false

    - name: "PROGRESS: Service startup complete"
      ansible.builtin.debug:
        msg: "PROGRESS_MARKER: start:04:Service_Startup"
      run_once: true

    # ==============================================================================
    # WAIT FOR ALL NODES TO REACH STAGE d
    # ==============================================================================
    - name: Wait for all nodes to reach stage 'd' (database ready)
      ansible.builtin.command:
        cmd: "c4 ps -e '.[].Instances.Configs | to_entries | all(.value.ground.boot_stage == \"d\")'"
      become_user: "{{ exa_user }}"
      register: stage_check
      until: stage_check.stdout | regex_search('true')
      retries: 120
      delay: 10
      changed_when: false
      failed_when: stage_check.stdout is not regex('true')
      run_once: true

    - name: Display database boot status
      ansible.builtin.debug:
        msg: "✓ All cluster nodes reached stage 'd' (database ready)"
      run_once: true

    - name: "PROGRESS: Database boot complete"
      ansible.builtin.debug:
        msg: "PROGRESS_MARKER: start:05:Database_Boot"
      run_once: true

    # ==============================================================================
    # VERIFY DATABASE IS RUNNING
    # ==============================================================================
    - name: Verify all services are active
      ansible.builtin.systemd:
        name: "{{ item }}"
      register: service_status
      failed_when:
        - service_status.status is defined
        - service_status.status.ActiveState != "active"
      loop:
        - c4.service
        - c4_cloud_command.service
        - exasol-admin-ui.service

    - name: Display start summary
      ansible.builtin.debug:
        msg:
          - "✓ {{ inventory_hostname }}: exasol-overlay.service started: {{ start_overlay.changed | default(false) }}"
          - "✓ {{ inventory_hostname }}: exasol-data-symlinks.service started: {{ start_data_symlinks.changed | default(false) }}"
          - "✓ {{ inventory_hostname }}: c4_cloud_command.service started: {{ start_cloud_command.changed | default(false) }}"
          - "✓ {{ inventory_hostname }}: c4.service started: {{ start_c4.changed }}"

    - name: Confirm successful start
      ansible.builtin.debug:
        msg: "✓ Exasol database cluster started successfully on all nodes (stage 'd')"
      run_once: true

    - name: "PROGRESS: Start complete"
      ansible.builtin.debug:
        msg: "PROGRESS_MARKER: start:06:Start_Complete"
      run_once: true

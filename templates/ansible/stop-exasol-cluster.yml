---
# ==============================================================================
# STOP EXASOL CLUSTER
# Gracefully stops the Exasol database cluster without terminating cloud instances.
# This playbook stops database services while preserving the infrastructure.
# ==============================================================================

# ==============================================================================
# PLAY 1: GATHER FACTS FROM ALL HOSTS
# ==============================================================================
- name: Play 1 - Gather Host Facts
  hosts: exasol_nodes
  become: yes
  tasks:
    - name: Ensure all host facts are gathered
      ansible.builtin.setup:

# ==============================================================================
# PLAY 2: STOP EXASOL DATABASE ON ALL NODES
# ==============================================================================
- name: Play 2 - Stop Exasol Database
  hosts: exasol_nodes
  become: yes
  gather_facts: no

  vars:
    exa_user: "exasol"

  tasks:
    # ==============================================================================
    # STOP OPERATION
    # ==============================================================================
    - name: Display stop operation information
      ansible.builtin.debug:
        msg: "Stopping Exasol database cluster..."
      when: inventory_hostname == groups['exasol_nodes'][0]

    # ==============================================================================
    # STOP DATABASE SERVICES VIA SYSTEMD ON ALL NODES
    # ==============================================================================
    - name: Check current status of c4.service
      ansible.builtin.systemd:
        name: c4.service
      register: c4_service_status
      failed_when: false

    - name: Display current service status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: c4.service is {{ c4_service_status.status.ActiveState }}"
      when: c4_service_status.status is defined

    # Stop the main database service first; Admin UI is PartOf=c4.service and will stop with it
    - name: Stop c4.service (main Exasol database service)
      ansible.builtin.systemd:
        name: c4.service
        state: stopped
      register: stop_c4

    - name: Wait for c4.service to stop completely
      ansible.builtin.wait_for:
        timeout: 30
      when: stop_c4.changed

    # Stop auxiliary services if they are running
    - name: Stop c4_cloud_command.service
      ansible.builtin.systemd:
        name: c4_cloud_command.service
        state: stopped
      register: stop_cloud_command
      failed_when: false

    - name: Stop exasol-admin-ui.service (ensure stopped even if not PartOf graph)
      ansible.builtin.systemd:
        name: exasol-admin-ui.service
        state: stopped
      register: stop_admin_ui
      failed_when: false

    - name: Verify all services are stopped
      ansible.builtin.systemd:
        name: "{{ item }}"
      register: service_status
      failed_when:
        - service_status.status is defined
        - service_status.status.ActiveState == "active"
      loop:
        - c4.service
        - c4_cloud_command.service
        - exasol-admin-ui.service

    # ==============================================================================
    # WAIT FOR ALL NODES TO REACH STAGE a/a1
    # ==============================================================================
    - name: Wait for nodes to reach stage a/a1 (services stopped)
      ansible.builtin.command:
        cmd: "c4 ps -e '.[].Instances.Configs | to_entries | map(.value.ground.boot_stage) | all(. == \"a\" or . == \"a1\")'"
      become_user: "{{ exa_user }}"
      register: stage_check
      until: stage_check.stdout | regex_search('true')
      retries: 60
      delay: 5
      changed_when: false
      failed_when: false
      run_once: true

    - name: Display stop summary
      ansible.builtin.debug:
        msg:
          - "✓ {{ inventory_hostname }}: c4_cloud_command.service stopped: {{ stop_cloud_command.changed | default(false) }}"
          - "✓ {{ inventory_hostname }}: exasol-admin-ui.service stopped: {{ stop_admin_ui.changed | default(false) }}"
          - "✓ {{ inventory_hostname }}: c4.service stopped: {{ stop_c4.changed }}"

    - name: Confirm successful stop
      ansible.builtin.debug:
        msg: "✓ Exasol database cluster stopped successfully on all nodes (stage a/a1)"
      when: inventory_hostname == groups['exasol_nodes'][0]

    - name: Power off hosts via in-guest shutdown (fallback for unsupported providers)
      ansible.builtin.shell: "shutdown now -h 'Exasol stop fallback'"
      become: true
      when: power_off_fallback | default(false)
      async: 1
      poll: 0
      ignore_errors: true
      changed_when: true

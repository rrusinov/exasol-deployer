{% raw -%}
#!/usr/bin/env bash
# Exoscale-specific script for creating stable /dev/exasol_data_* symlinks
# Runs on boot via systemd to ensure symlinks persist across reboots
#
# Generated by Ansible - DO NOT EDIT MANUALLY
# Volume IDs: {% endraw %}{{ volume_ids_comment }}{% raw %}

set -euo pipefail

# Volume IDs passed from Terraform/Ansible (sorted for stable ordering)
VOLUME_IDS=({% endraw %}{{ volume_ids_rendered }}{% raw %})
VOLUME_COUNT={% endraw %}{{ volume_ids_list | length }}{% raw %}

# Target symlink prefix
SYMLINK_PREFIX="/dev/exasol_data_"

# Log function
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | systemd-cat -t exasol-data-symlinks -p info
}

log "Starting Exasol data volume symlink creation for Exoscale"

# Remove any existing symlinks
for link in ${SYMLINK_PREFIX}*; do
    if [ -L "$link" ]; then
        rm -f "$link"
        log "Removed stale symlink: $link"
    fi
done

# Create symlinks for each volume in sorted order
disk_idx=1
for vol_id in "${VOLUME_IDS[@]}"; do
    # Exoscale volumes appear as virtio devices with truncated UUIDs
    # Full UUID: d1206e7a-b272-477e-9aa5-83c558c72a6d
    # Device link: /dev/disk/by-id/virtio-d1206e7a-b272-477e-9
    
    # Extract first 19 chars of UUID (matches virtio device naming)
    vol_id_short="${vol_id:0:19}"
    
    # Find the virtio device link for this volume
    target_device=""
    for link in /dev/disk/by-id/virtio-${vol_id_short}*; do
        if [[ -e "$link" ]]; then
            candidate_device=$(readlink -f "$link")
            if [[ -b "$candidate_device" ]] && [[ "$(lsblk -ndo TYPE "$candidate_device" 2>/dev/null)" == "disk" ]]; then
                # Skip if mounted at system paths (/, /boot, /var, etc.)
                if ! lsblk -nlo MOUNTPOINT "$candidate_device" | grep -q -E '^/(|boot|var|usr|opt|home|tmp|etc)(/|$)'; then
                    target_device="$candidate_device"
                    break
                else
                    log "SKIPPING: $candidate_device (volume: $vol_id) - has system partitions mounted"
                fi
            fi
        fi
    done
    
    if [[ -z "$target_device" ]]; then
        log "ERROR: Could not map volume $vol_id (looking for virtio-${vol_id_short}*)"
        log "Available virtio devices:"
        for dev in /dev/disk/by-id/virtio-*; do
            if [[ -e "$dev" ]]; then
                resolved=$(readlink -f "$dev" 2>/dev/null || echo '?')
                log "  $dev -> $resolved"
            fi
        done
        exit 1
    fi
    
    symlink_name=$(printf "${SYMLINK_PREFIX}%02d" "$disk_idx")
    ln -sf "$target_device" "$symlink_name"
    log "Created symlink: $symlink_name -> $target_device (volume: $vol_id)"
    ((disk_idx++))
done

symlink_count=$((disk_idx - 1))
log "Successfully created $symlink_count Exasol data volume symlinks"
exit 0
{%- endraw %}

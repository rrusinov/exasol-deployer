{
  "description": "Test node reboot and cluster recovery with health check validation",
  "steps": [
    {
      "step": "init"
    },
    {
      "step": "validate",
      "description": "Validate initialization",
      "checks": [
        "cluster_status==initialized"
      ]
    },
    {
      "step": "deploy"
    },
    {
      "step": "validate",
      "description": "Validate deployment",
      "checks": [
        "cluster_status==database_ready",
        "health_status[*].ssh==ok",
        "health_status[*].cos_ssh==ok",
        "health_status[*].adminui==ok",
        "health_status[*].database==ok"
      ], 
      "retry": {
        "max_attempts": 60,
        "delay_seconds": 10
      }
    },
    {
      "step": "restart_node",
      "description": "Reboot node n12 via SSH",
      "target_node": "n12",
      "method": "ssh"
    },
    {
      "step": "validate",
      "description": "Validate database is not running",
      "checks": [
        "health_status[*].database!=ok"
      ],     
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "custom_command",
      "description": "Wait for node reboot completion (uptime under 5 minutes)",
      "script": "wait_uptime_under.sh $deployment_dir n12 300",
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "validate",
      "description": "Wait for COS SSH recovery after reboot",
      "checks": [
        "health_status[*].cos_ssh==ok"
      ],
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "custom_command",
      "description": "Start database manually via COS SSH (if not already running)",
      "script": "start_db_if_needed.sh $deployment_dir n12-cos 100 5",
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "validate",
      "description": "Wait for database to become ready",
      "checks": [
        "cluster_status==database_ready",
        "health_status[*].database==ok"
      ],
      "retry": {
        "max_attempts": 60,
        "delay_seconds": 10
      }
    },
    {
      "step": "stop_cluster"
    },
    {
      "step": "validate",
      "description": "Validate cluster stopped",
      "checks": [
        "cluster_status==stopped",
        "health_status[*].ssh!=ok",
        "health_status[*].cos_ssh!=ok",
        "health_status[*].adminui!=ok",
        "health_status[*].database!=ok"
      ],     
      "retry": {
        "max_attempts": 60,
        "delay_seconds": 10
      }
    },
    {
      "step": "destroy"
    },
    {
      "step": "validate",
      "description": "Validate destruction",
      "checks": [
        "cluster_status==destroyed",
        "health_status[*].ssh!=ok",
        "health_status[*].cos_ssh!=ok",
        "health_status[*].adminui!=ok",
        "health_status[*].database!=ok"      
      ], 
      "retry": {
        "max_attempts": 60,
        "delay_seconds": 10
      }
    }
  ]
}

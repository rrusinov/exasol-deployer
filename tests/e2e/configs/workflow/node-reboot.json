{
  "description": "Test node reboot and cluster recovery with health check validation",
  "steps": [
    {
      "step": "init"
    },
    {
      "step": "validate",
      "description": "Validate initialization",
      "checks": [
        "cluster_status==initialized"
      ]
    },
    {
      "step": "deploy"
    },
    {
      "step": "validate",
      "description": "Validate deployment",
      "checks": [
        "cluster_status==database_ready",
        "health_status[*].ssh==ok",
        "health_status[*].cos_ssh==ok",
        "health_status[*].adminui==ok",
        "health_status[*].database==ok"
      ], 
      "retry": {
        "max_attempts": 6,
        "delay_seconds": 10
      }
    },
    {
      "step": "restart_node",
      "description": "Reboot node n12 via SSH",
      "target_node": "n12",
      "method": "ssh"
    },
    {
      "step": "custom_command",
      "description": "Wait for node reboot completion (uptime under 3 minutes)",
      "command": "uptime_secs=$(ssh -F $deployment_dir/ssh_config -o ConnectTimeout=10 -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR n12 \"cat /proc/uptime | cut -d. -f1\") && echo \"uptime=$uptime_secs\" && [ \"$uptime_secs\" -lt 300 ]",
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "validate",
      "description": "Wait for COS SSH recovery after reboot",
      "checks": [
        "health_status[*].cos_ssh==ok"
      ],
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "custom_command",
      "description": "Start database manually via COS SSH (if not already running)",
      "command": "ssh -F $deployment_dir/ssh_config -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR n11-cos 'dwad_client list | grep -qE \"State:[[:space:]]+running\" && echo Database already running || confd_client db_start db_name: Exasol'",
      "retry": {
        "max_attempts": 12,
        "delay_seconds": 10
      }
    },
    {
      "step": "validate",
      "description": "Wait for database to become ready",
      "checks": [
        "cluster_status==database_ready",
        "health_status[*].database==ok"
      ],
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "stop_cluster"
    },
    {
      "step": "validate",
      "description": "Validate cluster stopped",
      "checks": [
        "cluster_status==stopped",
        "health_status[*].ssh!=ok",
        "health_status[*].cos_ssh!=ok",
        "health_status[*].adminui!=ok",
        "health_status[*].database!=ok"
      ],     
      "retry": {
        "max_attempts": 6,
        "delay_seconds": 10
      }
    },
    {
      "step": "destroy"
    },
    {
      "step": "validate",
      "description": "Validate destruction",
      "checks": [
        "cluster_status==destroyed",
        "health_status[*].ssh!=ok",
        "health_status[*].cos_ssh!=ok",
        "health_status[*].adminui!=ok",
        "health_status[*].database!=ok"      
      ], 
      "retry": {
        "max_attempts": 6,
        "delay_seconds": 10
      }
    }
  ]
}

{
  "description": "Test node reboot and cluster recovery with health check validation",
  "steps": [
    {
      "step": "init"
    },
    {
      "step": "validate",
      "description": "Validate initialization",
      "checks": [
        "cluster_status==initialized"
      ]
    },
    {
      "step": "deploy"
    },
    {
      "step": "validate",
      "description": "Validate deployment",
      "checks": [
        "cluster_status==database_ready",
        "health_status[*].ssh==ok",
        "health_status[*].cos_ssh==ok",
        "health_status[*].adminui==ok",
        "health_status[*].database==ok"
      ]
    },
    {
      "step": "restart_node",
      "description": "Reboot node n12 via SSH",
      "target_node": "n12",
      "method": "ssh"
    },
    {
      "step": "validate",
      "description": "Wait for node to go down (COS SSH becomes unavailable)",
      "checks": [
        "health_status[*].cos_ssh!=ok"
      ],
      "retry": {
        "max_attempts": 100,
        "delay_seconds": 3
      }
    },
    {
      "step": "validate",
      "description": "Wait for COS SSH recovery after reboot",
      "checks": [
        "health_status[*].ssh==ok",
        "health_status[*].cos_ssh==ok",
        "health_status[*].adminui==ok"
      ],
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "custom_command",
      "description": "Start database manually via COS SSH (if not already running)",
      "command": "ssh -F $deployment_dir/ssh_config n11-cos 'dwad_client list | grep -qE \"State:[[:space:]]+running\" && echo Database already running || confd_client db_start db_name: Exasol'",
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "validate",
      "description": "Wait for database to become ready",
      "checks": [
        "cluster_status==database_ready",
        "health_status[*].database==ok"
      ],
      "retry": {
        "max_attempts": 30,
        "delay_seconds": 10
      }
    },
    {
      "step": "stop_cluster"
    },
    {
      "step": "validate",
      "description": "Validate cluster stopped",
      "checks": [
        "cluster_status==stopped",
        "health_status[*].ssh!=ok",
        "health_status[*].cos_ssh!=ok",
        "health_status[*].adminui!=ok",
        "health_status[*].database!=ok"
      ]
    },
    {
      "step": "destroy"
    },
    {
      "step": "validate",
      "description": "Validate destruction",
      "checks": [
        "cluster_status==destroyed",
        "health_status[*].ssh!=ok",
        "health_status[*].cos_ssh!=ok",
        "health_status[*].adminui!=ok",
        "health_status[*].database!=ok"      
      ]
    }
  ]
}
